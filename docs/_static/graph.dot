digraph G {
  graph [page="8,6", size="8, 6", ratio=fill]
  node [shape=box]
  cellvec [label="cell vectors", style="filled", fillcolor=lightgoldenrodyellow]
  spin [label="spin", style="filled", fillcolor=lightgoldenrodyellow]
  position [label="position", style="filled", fillcolor=lightgoldenrodyellow]
  charge [label="charge", style="filled", fillcolor=lightgoldenrodyellow]
  cutoff [label="cutoff energy", style="filled", fillcolor=lightgoldenrodyellow]
  
  v_local [label="V_local", style="filled", fillcolor=lightgoldenrodyellow]
  v_nonlocal [label="V_nonlocal", style="filled", fillcolor=lightgoldenrodyellow]
  
  coeff [label="PW coefficients (psi_g)", style="filled", fillcolor=lightskyblue]
  param_coeff [label="param_coeff", style="filled", fillcolor=lightcoral]
  
  occupation [label="occupation", style="filled", fillcolor=lightskyblue]
  param_occ [label="param_occupation", style="filled", fillcolor=lightcoral]
  
  wave_r [label="wave_grid"]
  dens_r [label="density_grid"]
  dens_g [label="density_grid_reciprocal"]
  
  vol [label="volume"]
  gpts [label="g-vectors"]
  kpts [label="k-vectors"]
  total_charge [label="total_charges"]
  
  e_har [label="E_hartree"]
  e_ext [label="E_external"]
  e_xc [label="E_xc"]
  e_kin [label="E_kinetic"]
  e_ewald [label="E_Ewald"]
  e_total [label="E_total"]
  
  v_har [label="V_hartree"]
  v_xc [label="V_xc"]
  v_ext [label="V_external"]
  grid_size [label = "grid_size", style="filled", fillcolor=lightgoldenrodyellow]
  
  hamil_matrix [label = "hamiltonian(full matrix)"]
  hamil_matrix_diag [label = "hamiltonian(diagonal)"]
  

  ####################################################
  
  param_coeff -> coeff [label="QR&Reshape"]
  coeff -> wave_r [label="iFFT"]
  
  wave_r -> dens_r
  dens_r -> dens_g [label="FFT"]
  
  cellvec -> freq_mask [style=dashed]
  cutoff -> freq_mask [style=dashed]
  
  param_occ -> occupation [label="QR"]
  
  subgraph cluster_ewald {
    label="ewald"
    shape=box
    style=dashed
    color=darkred
    // ewald_eta, ewald_cutoff
    ewald_eta [label="ewald_eta", style="filled", fillcolor=lightgoldenrodyellow]
    ewald_cutoff [label="ewald_cutoff", style="filled", fillcolor=lightgoldenrodyellow]
  }
  
  ewald_eta -> e_ewald
  ewald_cutoff -> e_ewald
  
  subgraph cluster_pp {
    label="Pseudopotential"
    shape=box
    style=filled
    fillcolor=lightblue
    v_local; v_nonlocal
  }
  
  subgraph cluster_potential {
    label="Effective Potential"
    shape=box
    style=dashed
    color=darkred
    v_har
    v_xc
    v_ext
  }
  
  subgraph cluster_cry {
    label="Crystal"
    shape=box
    style=dashed
    color=darkred
    vol;
    total_charge
    subgraph cluster_crystal {
      label="Crystal"
      shape=box
      style=filled
      fillcolor="lightblue"
      cellvec; charge; position; spin
    }
  }
  
  subgraph cluster_pot {
    label="Effective Potential"
    shape=box
    style=dashed
    color=darkred
    v_har
    v_xc
    v_ext
  }
  
  subgraph cluster_grid {
    label="grid"
    shape=box
    style=dashed
    color=darkred
    gpts; kpts; grid_size; freq_mask
  }
  
  subgraph cluster_energies {
    label="energies"
    shape=box
    style=dashed
    color=darkred
    e_har; e_ext; e_xc; e_kin; e_ewald; e_total;
  }
  
  subgraph cluster_pw {
    label="Planewave"
    shape=box
    style=dashed
    color=darkred
    coeff; param_coeff; wave_r; dens_r; dens_g;
    coeff -> dens_r
    coeff -> dens_g
  }
  
  subgraph cluster_occ {
    label="Occupation"
    shape=box
    style=dashed
    color=darkred
    occupation; param_occ
  }
  
  
  gpts -> e_ewald
  position -> e_ewald
  charge -> e_ewald
  
  charge -> total_charge
  cellvec -> vol
    
  vol -> e_ext
  vol -> e_har
  vol -> e_xc
  vol -> e_kin
  vol -> e_ewald
  
  v_local -> v_ext [style=dashed, color=darkgreen]
  v_nonlocal -> v_ext [style=dashed, color=darkgreen]
  
  v_ext -> e_ext
  dens_g -> e_ext
  
  position -> v_ext [color=darkslateblue]
  charge -> v_ext [color=darkslateblue]
  gpts -> v_ext [color=darkslateblue]
  
  cellvec -> gpts
  grid_size -> gpts
  grid_size -> kpts
  cellvec -> kpts
  
  grid_size -> coeff
  occupation -> dens_r
  
  grid_size -> occupation
  
  spin -> occupation
  total_charge -> occupation
  
  
  v_har -> e_har
  gpts -> v_har
  
  dens_g -> v_har
  dens_g -> e_har
  // gpts -> e_har
  dens_r -> v_xc [label = " JAX_XC"]
  dens_r -> e_xc
  v_xc -> e_xc  

  
  gpts -> e_kin
  kpts -> e_kin
  coeff -> e_kin
  
  e_har -> e_total
  e_ext -> e_total
  e_xc -> e_total
  e_kin -> e_total
  e_ewald -> e_total
  
  freq_mask -> wave_r
  
  e_total -> hamil_matrix [label=" hessian"]
  
  hamil_matrix -> band_structure [label=" eigendecomposition"]
  
  occupation -> Entropy
  
  Entropy -> E_free
  e_total -> E_free
  temperature -> E_free
  
  e_total -> hamil_matrix_diag [label=" Laplacian(?)"]
  
}
